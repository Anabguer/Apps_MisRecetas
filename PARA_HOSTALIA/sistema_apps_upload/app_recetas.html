<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mis Recetas</title>
    
    <!-- Ocultar barra de estado en móvil -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWA Manifest específico para Recetas -->
    <link rel="manifest" href="manifest_recetas.json">
    <meta name="theme-color" content="#22c55e">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/recetas-192.png">
    <link rel="apple-touch-icon" href="icons/recetas-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; }
        
        /* Header */
        .mobile-header {
            background: #f8f9fa;
            padding: 1rem;
            padding-top: max(2.5rem, env(safe-area-inset-top, 2.5rem)); /* Respeta safe area + espacio extra */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            width: 100%;
        }
        
        .mobile-header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .mobile-logo {
            display: flex;
            align-items: center;
        }
        
        .mobile-logo-icon {
            font-size: 1.5rem;
            color: #22c55e;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-logo-text {
            font-size: 0.75rem;
            font-weight: 700;
            color: #22c55e;
            line-height: 1;
        }
        
        .mobile-user-greeting {
            color: #45b7d1;
            font-size: 0.60rem;
            font-weight: 600;
            text-align: left;
            flex: 1;
            padding-left: 1rem;
        }
        
        .mobile-logout-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* Filters */
        .mobile-filters-panel {
            background: #f8f9fa;
            padding: 0.25rem 1rem;
            position: fixed;
            top: 91px; /* Ajustado para el header más grande */
            left: 0;
            right: 0;
            z-index: 99;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .mobile-filters-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            min-height: 36px;
        }
        
        .mobile-filter-types {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            flex: 1;
            overflow-x: auto;
            padding: 0.25rem 0;
            min-width: 0;
            /* Ocultar scrollbar pero mantener funcionalidad */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .mobile-filter-types::-webkit-scrollbar {
            display: none;
        }
        
        .mobile-filter-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .mobile-filter-circle:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .mobile-filter-circle.active {
            background: #8b5cf6;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            border: 2px solid #7c3aed;
        }
        
        .mobile-new-recipe-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #22c55e;
            color: white;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }
        
        /* Content */
        .content {
            padding-top: 129px; /* Ajustado para header y filtros más grandes */
            padding-bottom: 2rem;
        }

        /* Content cuando está en login (sin header visible) */
        .content.login-mode {
            padding-top: 1rem; /* Mucho menos espacio arriba en login */
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 0.5rem auto; /* Reducido de 2rem a 0.5rem */
            padding: 2rem;
            background: #f8f9fa; /* Mismo color que el fondo general */
            border-radius: 12px;
            box-shadow: none; /* Eliminada la sombra para integración */
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        
        .btn-primary { background: #22c55e; color: white; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        
        /* Recipes */
        .recipes-container {
            padding: 0 1rem;
        }
        
        .recipe-counter {
            background: white;
            padding: 1.75rem 1rem 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            color: #374151;
        }
        
        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .recipe-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .recipe-card:hover {
            transform: translateY(-2px);
        }
        
        .recipe-image {
            width: 100%;
            height: 120px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            overflow: hidden;
        }
        
        .recipe-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .recipe-content {
            padding: 1rem;
        }
        
        .recipe-name {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }
        
        .recipe-type {
            color: #6b7280;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        
        .recipe-rating {
            color: #f59e0b;
            font-size: 0.8rem;
        }
        
        .hidden { display: none !important; }
        .error { background: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 8px; margin: 1rem; }
        
        /* ===== MODALES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f8f9fa;
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-form .form-group {
            margin-bottom: 1rem;
        }
        
        .modal-form label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .modal-form input, .modal-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .modal-form input:focus, .modal-form textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .type-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .type-button:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .type-button.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        
        .health-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .health-toggle-input {
            display: none;
        }
        
        .health-toggle-slider {
            width: 3rem;
            height: 1.5rem;
            background: #e5e7eb;
            border-radius: 0.75rem;
            position: relative;
            transition: background 0.2s;
        }
        
        .health-toggle-input:checked + .health-toggle-slider {
            background: #22c55e;
        }
        
        .health-toggle-knob {
            width: 1.25rem;
            height: 1.25rem;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 0.125rem;
            left: 0.125rem;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .health-toggle-input:checked + .health-toggle-slider .health-toggle-knob {
            transform: translateX(1.5rem);
        }
        
        .btn-modal-primary {
            background: #22c55e;
            color: white;
            padding: 0.5rem;
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
        }
        
        .btn-modal-primary:hover {
            background: #16a34a;
            transform: scale(1.05);
        }
        
        .btn-modal-secondary {
            background: #f3f4f6;
            color: #374151;
            padding: 0.5rem;
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-modal-secondary:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }
        
        /* ===== COMPONENTES DE IMAGEN/VIDEO ===== */
        .image-no-preview {
            width: 100%;
            height: 120px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }
        
        /* Video containers más compactos */
        .image-no-preview.video-container {
            height: 60px;
            min-height: 60px;
        }
        
        .image-no-preview:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .image-no-preview-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .image-no-preview-icon {
            font-size: 2rem;
            color: #6b7280;
        }
        
        .image-no-preview-text {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .image-preview-container {
            position: relative;
            width: 100%;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .image-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .image-change-btn {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .video-preview-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
        }
        
        .video-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .video-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .video-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .video-btn-change {
            background: #3b82f6;
            color: white;
        }
        
        .video-btn-remove {
            background: #ef4444;
            color: white;
        }
        
        /* Input de archivo que funciona en móviles (igual que test) */
        .file-input-working {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
            background: white;
            cursor: pointer;
        }
        
        .file-input-working:hover {
            border-color: #007bff;
        }

        /* Estilos específicos para inputs móviles optimizados */
        .mobile-file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .mobile-file-button {
            position: relative;
            display: block;
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }

        .mobile-file-button:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .mobile-file-button:active {
            transform: scale(0.98);
        }

        /* Estrellas de valoración */
        .star {
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.3;
        }
        
        .star:hover {
            transform: scale(1.2);
        }
        
        .star.active {
            opacity: 1;
        }

        /* Estilos para pestañas de autenticación */
        .tab-button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: #374151;
        }

        .tab-button.active {
            color: #22c55e;
            border-bottom-color: #22c55e;
        }

        .auth-form {
            transition: opacity 0.3s ease;
        }

        .auth-form.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- TEST MOBILE DEBUG -->

    <!-- Header -->
    <header class="mobile-header hidden" id="header">
        <div class="mobile-header-content">
            <div class="mobile-logo">
                <span class="mobile-logo-icon">🍃</span>
                <div class="mobile-logo-text">
                    <div>Mis</div>
                    <div>Recetas</div>
                </div>
            </div>
            <div class="mobile-user-greeting">
                <div>👋 Hola</div>
                <div id="userName">Usuario</div>
            </div>
            <button class="mobile-logout-btn" onclick="logout()">Salir</button>
        </div>
    </header>

    <!-- Filters -->
    <div class="mobile-filters-panel hidden" id="filtersPanel">
        <div class="mobile-filters-row">
            <div class="mobile-filter-types">
                <button class="mobile-filter-circle active" onclick="filterByType('')" title="Todos">🍽️</button>
                <button class="mobile-filter-circle" onclick="filterByType('Entrante')" title="Entrante">🫒</button>
                <button class="mobile-filter-circle" onclick="filterByType('Principal')" title="Principal">🥘</button>
                <button class="mobile-filter-circle" onclick="filterByType('Postre')" title="Postre">🍰</button>
                <button class="mobile-filter-circle" onclick="filterByType('Bebida')" title="Bebida">🥤</button>
                <button class="mobile-filter-circle" onclick="filterByType('Extra')" title="Extra">🧺</button>
                <button class="mobile-filter-circle" onclick="toggleSaludable()" title="Saludable" id="saludableBtn">💚</button>
                <button class="mobile-filter-circle" onclick="toggleSearch()" title="Buscar" id="searchBtn">🔍</button>
            </div>
            <div class="mobile-actions">
                <button class="mobile-new-recipe-btn" onclick="newRecipe()" title="Nueva Receta">➕</button>
            </div>
        </div>
        <!-- Search Input - DENTRO DEL PANEL DE FILTROS -->
        <div style="width: 100%; margin-top: 0.75rem;">
            <input type="text" id="searchInput" placeholder="Buscar recetas..." style="display: none; width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box;" oninput="onSearchInput(event)">
        </div>
    </div>

    <!-- Content -->
    <div class="content login-mode" id="mainContent">
        <!-- Login/Register -->
        <div class="login-container" id="loginContainer">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🍃</div>
                <h2>Mis Recetas</h2>
            </div>
            
            <!-- Pestañas Login/Register -->
            <div style="display: flex; margin-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                <button type="button" id="loginTab" class="tab-button active" onclick="showLoginForm()">Iniciar Sesión</button>
                <button type="button" id="registerTab" class="tab-button" onclick="showRegisterForm()">Registrarse</button>
            </div>
            
            <!-- Formulario de Login -->
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="tu@email.com" required oninput="hideError()">
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="loginPassword" required oninput="hideError()">
                </div>
                <button type="submit" class="btn btn-primary">Entrar</button>
                <button type="button" class="btn btn-secondary" onclick="clearSavedCredentials()" style="margin-top: 0.5rem; font-size: 0.8rem; padding: 0.5rem;">
                    🗑️ Limpiar credenciales guardadas
                </button>
            </form>

            <!-- Formulario de Registro -->
            <form id="registerForm" class="auth-form hidden">
                <div class="form-group">
                    <label>Nombre completo</label>
                    <input type="text" id="registerName" placeholder="Tu nombre completo" required oninput="hideError()">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="tu@email.com" required oninput="hideError()">
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="registerPassword" minlength="6" placeholder="Mínimo 6 caracteres" required oninput="hideError()">
                </div>
                <div class="form-group">
                    <label>Confirmar contraseña</label>
                    <input type="password" id="registerPasswordConfirm" minlength="6" placeholder="Repetir contraseña" required oninput="hideError()">
                </div>
                <button type="submit" class="btn btn-primary">Registrarse</button>
                <p style="font-size: 0.8rem; color: #6b7280; margin-top: 1rem; text-align: center;">
                    📧 Recibirás un código de verificación en tu email
                </p>
            </form>

            <!-- Formulario de Verificación -->
            <form id="verifyForm" class="auth-form hidden">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">📧</div>
                    <h3>Verificar tu email</h3>
                    <p style="color: #6b7280;">Hemos enviado un código de 6 dígitos a:</p>
                    <p style="font-weight: 600;" id="verifyEmailDisplay"></p>
                </div>
                <div class="form-group">
                    <label>Código de verificación</label>
                    <input type="text" id="verifyCode" placeholder="123456" maxlength="6" pattern="[0-9]{6}" required oninput="hideError()">
                </div>
                <button type="submit" class="btn btn-primary">Verificar</button>
                <button type="button" class="btn btn-secondary" onclick="resendVerificationCode()">Reenviar código</button>
                <button type="button" class="btn btn-secondary" onclick="backToRegister()">Volver</button>
            </form>
        </div>

        <!-- Recipes -->
        <div class="recipes-container hidden" id="recipesContainer">
            <div class="recipe-counter" id="recipeCounter">
                <!-- Contador se actualiza aquí -->
            </div>
            <div class="recipes-grid" id="recipesGrid">
                <!-- Recetas se cargan aquí -->
            </div>
        </div>
        
        <div class="error hidden" id="error"></div>
    </div>

    <script>
        // ===== DEBUG MOBILE: MOSTRAR INFO EN PANTALLA =====
        
        const API_BASE = 'https://colisan.com/sistema_apps_upload/sistema_apps_api/recetas/';
        let currentUser = null;
        let currentToken = null;
        let allRecipes = [];
        let currentFilter = '';

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('verifyForm').addEventListener('submit', handleVerification);
            
            // Cargar credenciales guardadas al iniciar
            loadSavedCredentials();
        });

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(API_BASE + 'auth_register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'login',
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.data.user;
                    currentToken = data.data.token;
                    
                    // Guardar credenciales para próximos logins
                    saveCredentials(email, password);
                    
                    showRecipes();
                } else {
                    showError(data.error || 'Error de login');
                }
            } catch (error) {
                showError('Error de conexión: ' + error.message);
            }
        }

        async function loadRecipes() {
            try {
                const response = await fetch(API_BASE + 'list.php?token=' + encodeURIComponent(currentToken));
                const data = await response.json();
                
                if (data.success && data.data && data.data.recetas) {
                    allRecipes = data.data.recetas;
                    displayRecipes(allRecipes);
                    updateCounter(allRecipes.length, false);
                } else {
                    showError('Error cargando recetas: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function displayRecipes(recetas) {
            const grid = document.getElementById('recipesGrid');
            grid.innerHTML = '';
            
            // LIMPIAR TODOS LOS DATOS DE RECETAS ANTES DE PROCESARLAS
            recetas = recetas.map(receta => {
                // Crear copia limpia de la receta
                const recetaLimpia = {...receta};
                
                // LIMPIEZA BRUTAL - ELIMINAR TODO LO QUE NO SEA LETRA/NÚMERO/ESPACIO
                if (recetaLimpia.receta_nombre) {
                    // Convertir a string y limpiar TODO
                    let nombre = String(recetaLimpia.receta_nombre);
                    
                    // Método 1: Eliminar caracteres específicos problemáticos
                    nombre = nombre.replace(/[""''""''«»„‚‛‟]/g, '');
                    nombre = nombre.replace(/[><]/g, '');
                    nombre = nombre.replace(/&[^;]+;/g, '');
                    
                    // Método 2: Solo mantener caracteres seguros
                    nombre = nombre.replace(/[^\w\sáéíóúñÁÉÍÓÚÑüÜ.,():-]/g, '');
                    
                    // Limpiar espacios múltiples y trim
                    nombre = nombre.replace(/\s+/g, ' ').trim();
                    
                    recetaLimpia.receta_nombre = nombre || 'Sin nombre';
                }
                
                return recetaLimpia;
            });
            
            recetas.forEach(receta => {
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.onclick = () => viewRecipe(receta);
                
                // El nombre ya está limpio desde arriba
                const cleanName = receta.receta_nombre || 'Sin nombre';
                
                // Crear contenedor de imagen SIN inline JS problemático
                const imgBox = document.createElement('div');
                imgBox.className = 'recipe-image';
                imgBox.style.background = '#f3f4f6';
                
                if (receta.receta_image && receta.receta_image.trim() !== '') {
                    const img = document.createElement('img');
                    // Agregar timestamp para evitar caché
                    const separator = receta.receta_image.includes('?') ? '&' : '?';
                    img.src = receta.receta_image + separator + 'v=' + Date.now();
                    img.alt = cleanName;
                    img.addEventListener('error', () => {
                        img.remove(); // Deja solo el fondo gris
                    });
                    imgBox.appendChild(img);
                }
                
                // Obtener icono del tipo
                const tipoIconos = {
                    'Entrante': '🫒',
                    'Principal': '🥘', 
                    'Postre': '🍰',
                    'Bebida': '🥤',
                    'Extra': '🧺'
                };
                const tipoIcono = tipoIconos[receta.receta_tipo] || '🍽️';
                
                // Iconos de estado (saludable y video)
                let estadoIconos = '';
                if (receta.receta_saludable) {
                    estadoIconos += ' 💚';
                }
                if (receta.receta_video && receta.receta_video.trim() !== '') {
                    estadoIconos += ` <span style="cursor:pointer;" onclick="event.stopPropagation(); openVideoModal('${receta.receta_video}');" title="Ver video">📹</span>`;
                }
                
                // Crear contenido de la card SIN innerHTML problemático
                const contentDiv = document.createElement('div');
                contentDiv.className = 'recipe-content';
                contentDiv.innerHTML = `
                    <div class="recipe-name">${cleanName}</div>
                    <div class="recipe-type">${tipoIcono} ${receta.receta_tipo}</div>
                    <div class="recipe-rating">⭐ ${receta.receta_valoracion || 0}/5${estadoIconos}</div>
                `;
                
                // Ensamblar card
                card.appendChild(imgBox);
                card.appendChild(contentDiv);
                grid.appendChild(card);
            });
        }

        function filterByType(tipo) {
            // Remover active de todos los filtros de tipo (no del saludable ni búsqueda)
            document.querySelectorAll('.mobile-filter-circle').forEach(function(btn) {
                if (btn.id !== 'saludableBtn' && btn.id !== 'searchBtn') {
                    btn.classList.remove('active');
                }
            });
            
            // Encontrar el botón correcto y marcarlo como activo
            const buttons = document.querySelectorAll('.mobile-filter-circle');
            buttons.forEach(function(btn) {
                if (btn.id !== 'saludableBtn' && btn.id !== 'searchBtn') {
                    if ((tipo === '' && btn.title === 'Todos') ||
                        (tipo !== '' && btn.title === tipo)) {
                        btn.classList.add('active');
                    }
                }
            });
            
            // Filtrar recetas
            currentFilter = tipo;
            applyFilters();
        }

        function updateCounter(count, isFiltered) {
            const counter = document.getElementById('recipeCounter');
            const text = isFiltered ? `${count} receta${count !== 1 ? 's' : ''} ${currentFilter} (filtradas)` : `${count} receta${count !== 1 ? 's' : ''}`;
            counter.textContent = text;
        }

        let currentRecipe = null;
        
        function viewRecipe(receta) {
            currentRecipe = receta;
            
            // Rellenar datos del modal
            document.getElementById('detailRecipeName').textContent = receta.receta_nombre;
            document.getElementById('detailRecipeType').textContent = receta.receta_tipo;
            document.getElementById('detailRecipeRating').textContent = `⭐ ${receta.receta_valoracion || 0}/5`;
            document.getElementById('detailRecipeTime').textContent = receta.receta_tiempopreparacion ? `${receta.receta_tiempopreparacion} min` : 'No especificado';
            document.getElementById('detailRecipePortions').textContent = receta.receta_porciones ? `${receta.receta_porciones} porc` : 'No especificado';
            
            // Mostrar imagen
            const imageContainer = document.getElementById('detailRecipeImage');
            if (receta.receta_image && receta.receta_image.trim() !== '') {
                // Agregar timestamp para evitar caché
                const separator = receta.receta_image.includes('?') ? '&' : '?';
                const imageUrl = receta.receta_image + separator + 'v=' + Date.now();
                imageContainer.innerHTML = `<img src="${imageUrl}" alt="${receta.receta_nombre}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">`;
            } else {
                imageContainer.innerHTML = '<div style="width: 100%; height: 200px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6b7280;">Sin imagen</div>';
            }
            
            // Mostrar ingredientes
            document.getElementById('detailRecipeIngredients').textContent = receta.receta_ingredients || 'No especificados';
            
            // Mostrar preparación  
            document.getElementById('detailRecipePreparation').textContent = receta.receta_preparation || 'No especificada';
            
            // Mostrar indicadores
            document.getElementById('detailRecipeHealthy').style.display = receta.receta_saludable ? 'inline' : 'none';
            document.getElementById('detailRecipeVideo').style.display = (receta.receta_video && receta.receta_video.trim() !== '') ? 'inline' : 'none';
            
            // Abrir modal
            document.getElementById('recipeDetailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // ===== FUNCIONES DE MODALES =====
        
        function newRecipe() {
            document.getElementById('newRecipeModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Bloquear scroll
            // Limpiar formulario
            document.getElementById('newRecipeForm').reset();
            document.getElementById('newRecipeType').value = '';
            // Desactivar todos los botones de tipo
            document.querySelectorAll('#newRecipeModal .type-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // Inicializar componentes de imagen/video
            initializeNewRecipeModal();
        }
        
        function closeNewRecipeModal() {
            document.getElementById('newRecipeModal').classList.add('hidden');
            document.body.style.overflow = 'auto'; // Restaurar scroll
        }
        
        function selectNewType(tipo) {
            // Desactivar todos los botones
            document.querySelectorAll('#newRecipeModal .type-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar el seleccionado
            document.querySelector(`#newRecipeModal .type-button[data-type="${tipo}"]`).classList.add('active');
            document.getElementById('newRecipeType').value = tipo;
        }
        
        function saveNewRecipe() {
            const form = document.getElementById('newRecipeForm');
            const formData = new FormData();
            
            // Validar campos requeridos
            const nombre = document.getElementById('newRecipeName').value.trim();
            const tipo = document.getElementById('newRecipeType').value;
            
            if (!nombre) {
                alert('El nombre de la receta es obligatorio');
                return;
            }
            
            if (!tipo) {
                alert('Selecciona un tipo de receta');
                return;
            }
            
            // Recopilar datos
            formData.append('nombre', nombre);
            formData.append('tipo', tipo);
            formData.append('saludable', document.getElementById('newRecipeHealthy').checked ? 1 : 0);
            formData.append('tiempo', document.getElementById('newRecipeTime').value || 0);
            formData.append('porciones', document.getElementById('newRecipePortions').value || 1);
            formData.append('valoracion', document.getElementById('newRecipeRating').value || 0);
            formData.append('ingredientes', document.getElementById('newRecipeIngredients').value);
            formData.append('preparacion', document.getElementById('newRecipePreparation').value);
            formData.append('token', currentToken);
            
            // Archivos
            const imageFile = document.getElementById('newRecipeImage').files[0];
            const videoFile = document.getElementById('newRecipeVideo').files[0];
            
            if (imageFile) formData.append('imagen', imageFile);
            if (videoFile) formData.append('video', videoFile);
            
            // Enviar a API
            fetch(API_BASE + 'create.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Receta creada exitosamente');
                    closeNewRecipeModal();
                    loadRecipes(); // Recargar lista
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error de conexión: ' + error.message);
            });
        }
        
        function selectEditType(tipo) {
            // Desactivar todos los botones
            document.querySelectorAll('#editRecipeModal .type-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar el seleccionado
            document.querySelector(`#editRecipeModal .type-button[data-type="${tipo}"]`).classList.add('active');
            document.getElementById('editRecipeType').value = tipo;
        }
        
        function closeEditRecipeModal() {
            document.getElementById('editRecipeModal').classList.add('hidden');
            document.body.style.overflow = 'auto'; // Restaurar scroll
        }
        
        function saveEditRecipe() {
            alert('Función de editar por implementar');
        }
        
        // ===== FUNCIONES DE IMAGEN/VIDEO =====
        
        // Funciones para validar antes de abrir selector
        // Función eliminada - ahora el input es directamente clickeable
        
        // Función eliminada - ahora el input es directamente clickeable
        
        function handleNewImageUpload(input) {
            // Validar que existan nombre y tipo antes de subir imagen
            const nombre = document.getElementById('newRecipeName').value.trim();
            const tipo = document.getElementById('newRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de subir la imagen');
                input.value = ''; // Limpiar selección
                return;
            }
            
            const file = input.files[0];
            if (!file) return;
            
            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen válido');
                return;
            }
            
            // Crear preview
            const reader = new FileReader();
            reader.onload = function(e) {
                // Mostrar preview inmediatamente
                renderNewImageUploader(e.target.result);
                document.getElementById('newImageUrl').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function handleNewVideoUpload(input) {
            // Validar que existan nombre y tipo antes de subir video
            const nombre = document.getElementById('newRecipeName').value.trim();
            const tipo = document.getElementById('newRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de subir el video');
                input.value = ''; // Limpiar selección
                return;
            }
            
            const file = input.files[0];
            if (!file) return;
            
            // Validar tipo de archivo
            if (!file.type.startsWith('video/')) {
                alert('Por favor selecciona un archivo de video válido');
                return;
            }
            
            // Crear preview
            const fileName = file.name;
            renderNewVideoUploader(fileName);
            document.getElementById('newVideoUrl').value = fileName;
        }
        
        function renderNewImageUploader(imageUrl) {
            const container = document.getElementById('newImageContainer');
            
            if (imageUrl && imageUrl.trim() !== '') {
                // Mostrar imagen con botones
                container.innerHTML = `
                    <div class="image-preview-container">
                        <img src="${imageUrl}" alt="Vista previa" class="image-preview-img">
                        <button type="button" onclick="event.stopPropagation(); removeNewImage()" class="image-remove-btn" title="Eliminar imagen">✕</button>
                    </div>
                `;
            } else {
                // BOTÓN OPTIMIZADO PARA MÓVIL - MÉTODO MEJORADO
                container.innerHTML = `
                    <div class="mobile-file-button" onclick="openNewImageSelector()">
                        <span class="image-no-preview-icon">📷</span>
                        <span class="image-no-preview-text">Seleccionar imagen</span>
                    </div>
                `;
            }
        }
        
        function renderNewVideoUploader(fileName) {
            const container = document.getElementById('newVideoContainer');
            
            if (fileName && fileName.trim() !== '') {
                // Mostrar área con botones: ver, cambiar, quitar
                container.innerHTML = `
                    <div class="image-no-preview video-container" style="background: #f0f9ff; border-color: #3b82f6;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" onclick="viewNewVideo()" class="video-btn" style="background: #10b981; color: white;">👁️ Ver</button>
                            <button type="button" onclick="removeNewVideo()" class="video-btn video-btn-remove">✕ Quitar</button>
                        </div>
                    </div>
                `;
            } else {
                // BOTÓN OPTIMIZADO PARA MÓVIL - MÉTODO MEJORADO
                container.innerHTML = `
                    <div class="mobile-file-button" onclick="openNewVideoSelector()">
                        <span class="image-no-preview-icon">🎥</span>
                        <span class="image-no-preview-text">Seleccionar video</span>
                    </div>
                `;
            }
        }
        
        function removeNewImage() {
            document.getElementById('newRecipeImage').value = '';
            document.getElementById('newImageUrl').value = '';
            renderNewImageUploader('');
        }
        
        function removeNewVideo() {
            document.getElementById('newRecipeVideo').value = '';
            document.getElementById('newVideoUrl').value = '';
            renderNewVideoUploader('');
        }
        
        // Funciones para validar antes de abrir selector (NUEVA RECETA) - MÉTODO MEJORADO PARA MÓVILES
        function openNewImageSelector() {
            const nombre = document.getElementById('newRecipeName').value.trim();
            const tipo = document.getElementById('newRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de seleccionar la imagen');
                return;
            }
            
            // MÉTODO OPTIMIZADO PARA WEBVIEW MÓVIL
            const input = document.getElementById('newRecipeImage');
            
            // Método 1: Trigger directo
            try {
                input.click();
            } catch (e) {
                // Método 2: Si falla, crear evento programático
                const event = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                input.dispatchEvent(event);
            }
        }
        
        function openNewVideoSelector() {
            const nombre = document.getElementById('newRecipeName').value.trim();
            const tipo = document.getElementById('newRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de seleccionar el video');
                return;
            }
            
            // MÉTODO OPTIMIZADO PARA WEBVIEW MÓVIL
            const input = document.getElementById('newRecipeVideo');
            
            // Método 1: Trigger directo
            try {
                input.click();
            } catch (e) {
                // Método 2: Si falla, crear evento programático
                const event = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                input.dispatchEvent(event);
            }
        }
        
        // Inicializar componentes al abrir modal
        function initializeNewRecipeModal() {
            renderNewImageUploader('');
            renderNewVideoUploader('');
            // Inicializar estrellas en 0 (todas grises)
            updateStars('#newRecipeModal', 0);
            document.getElementById('newRecipeRating').value = 0;
        }
        
        // ===== FUNCIONES EDICIÓN IMAGEN/VIDEO =====
        
        // Funciones para validar antes de abrir selector (EDITAR)
        function openEditImageSelector() {
            const nombre = document.getElementById('editRecipeName').value.trim();
            const tipo = document.getElementById('editRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de cambiar la imagen');
                return;
            }
            
            // Método que funciona mejor en móviles
            const input = document.getElementById('editRecipeImage');
            input.style.display = 'block';
            input.style.position = 'absolute';
            input.style.top = '0';
            input.style.left = '0';
            input.style.width = '100%';
            input.style.height = '100%';
            input.style.opacity = '0';
            input.style.zIndex = '1000';
            
            setTimeout(() => {
                input.click();
                setTimeout(() => {
                    input.style.display = 'none';
                }, 100);
            }, 50);
        }
        
        function openEditVideoSelector() {
            const nombre = document.getElementById('editRecipeName').value.trim();
            const tipo = document.getElementById('editRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de cambiar el video');
                return;
            }
            
            // Método que funciona mejor en móviles
            const input = document.getElementById('editRecipeVideo');
            input.style.display = 'block';
            input.style.position = 'absolute';
            input.style.top = '0';
            input.style.left = '0';
            input.style.width = '100%';
            input.style.height = '100%';
            input.style.opacity = '0';
            input.style.zIndex = '1000';
            
            setTimeout(() => {
                input.click();
                setTimeout(() => {
                    input.style.display = 'none';
                }, 100);
            }, 50);
        }
        
        function handleEditImageUpload(input) {
            // Validar que existan nombre y tipo antes de subir imagen
            const nombre = document.getElementById('editRecipeName').value.trim();
            const tipo = document.getElementById('editRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de cambiar la imagen');
                input.value = ''; // Limpiar selección
                return;
            }
            
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen válido');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Mostrar preview inmediatamente con timestamp para evitar caché
                renderEditImageUploader(e.target.result);
                document.getElementById('editImageUrl').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function handleEditVideoUpload(input) {
            // Validar que existan nombre y tipo antes de subir video
            const nombre = document.getElementById('editRecipeName').value.trim();
            const tipo = document.getElementById('editRecipeType').value;
            
            if (!nombre || !tipo) {
                alert('⚠️ Debes completar el NOMBRE y seleccionar un TIPO antes de cambiar el video');
                input.value = ''; // Limpiar selección
                return;
            }
            
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('video/')) {
                alert('Por favor selecciona un archivo de video válido');
                return;
            }
            
            const fileName = file.name;
            renderEditVideoUploader(fileName);
            document.getElementById('editVideoUrl').value = fileName;
        }
        
        function renderEditImageUploader(imageUrl) {
            const container = document.getElementById('editImageContainer');
            
            if (imageUrl && imageUrl.trim() !== '') {
                // Agregar timestamp para evitar caché si es una URL externa
                let displayUrl = imageUrl;
                if (imageUrl.startsWith('http') && !imageUrl.includes('?v=')) {
                    const separator = imageUrl.includes('?') ? '&' : '?';
                    displayUrl = imageUrl + separator + 'v=' + Date.now();
                }
                
                container.innerHTML = `
                    <div class="image-preview-container">
                        <img src="${displayUrl}" alt="Vista previa" class="image-preview-img">
                        <button type="button" onclick="event.stopPropagation(); removeEditImage()" class="image-remove-btn" title="Eliminar imagen">✕</button>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <button type="button" onclick="openEditImageSelector()" class="btn btn-primary" style="font-size: 14px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px;">
                            <i class="fas fa-camera"></i> Cambiar Imagen
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="image-no-preview">
                        <div class="image-no-preview-button" onclick="openEditImageSelector()">
                            <span class="image-no-preview-icon">📷</span>
                            <span class="image-no-preview-text">Seleccionar imagen</span>
                        </div>
                    </div>
                `;
            }
        }
        
        function renderEditVideoUploader(fileName) {
            const container = document.getElementById('editVideoContainer');
            
            if (fileName && fileName.trim() !== '') {
                // Mostrar área con botones: ver, cambiar, quitar
                container.innerHTML = `
                    <div class="image-no-preview video-container" style="background: #f0f9ff; border-color: #3b82f6;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" onclick="viewEditVideo()" class="video-btn" style="background: #10b981; color: white;">👁️ Ver</button>
                            <button type="button" onclick="openEditVideoSelector()" class="video-btn" style="background: #3b82f6; color: white;">🎥 Cambiar</button>
                            <button type="button" onclick="removeEditVideo()" class="video-btn video-btn-remove">✕ Quitar</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="image-no-preview">
                        <div class="image-no-preview-button" onclick="openEditVideoSelector()">
                            <span class="image-no-preview-icon">🎥</span>
                            <span class="image-no-preview-text">Seleccionar video</span>
                        </div>
                    </div>
                `;
            }
        }
        
        function removeEditImage() {
            document.getElementById('editRecipeImage').value = '';
            document.getElementById('editImageUrl').value = '';
            renderEditImageUploader('');
        }
        
        function removeEditVideo() {
            document.getElementById('editRecipeVideo').value = '';
            document.getElementById('editVideoUrl').value = '';
            renderEditVideoUploader('');
        }
        
        // ===== FUNCIONES VISUALIZAR VIDEO =====
        
        function viewNewVideo() {
            const file = document.getElementById('newRecipeVideo').files[0];
            if (file) {
                const videoUrl = URL.createObjectURL(file);
                openVideoModal(videoUrl);
            }
        }
        
        function viewEditVideo() {
            const videoUrl = document.getElementById('editVideoUrl').value;
            if (videoUrl) {
                openVideoModal(videoUrl);
            }
        }
        
        function openVideoModal(videoUrl) {
            // Crear modal de video temporal
            const videoModal = document.createElement('div');
            videoModal.id = 'videoModal';
            videoModal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 2000;
                display: flex; align-items: center; justify-content: center;
                padding: 1rem;
            `;
            
            // Cerrar al hacer click en el fondo
            videoModal.onclick = function(e) {
                if (e.target === videoModal) {
                    closeVideoModal();
                }
            };
            
            videoModal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 1rem; max-width: 90vw; max-height: 90vh;" onclick="event.stopPropagation();">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; color: #374151;">Vista previa del video</h3>
                        <button onclick="closeVideoModal()" 
                                style="background: #f3f4f6; border: none; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;">✕</button>
                    </div>
                    <video id="modalVideo" controls autoplay muted playsinline style="max-width: 100%; max-height: 70vh;">
                        <source src="${videoUrl}" type="video/mp4">
                        Tu navegador no soporta la reproducción de video.
                    </video>
                </div>
            `;
            
            document.body.appendChild(videoModal);
            document.body.style.overflow = 'hidden';
            
            // FORZAR REPRODUCCIÓN EN MÓVIL
            setTimeout(() => {
                const video = document.getElementById('modalVideo');
                if (video) {
                    video.play().catch(error => {
                        console.log('Autoplay bloqueado:', error);
                        // Si falla el autoplay, mostrar mensaje al usuario
                        const playButton = document.createElement('button');
                        playButton.innerHTML = '▶️ Reproducir Video';
                        playButton.style.cssText = `
                            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: rgba(0,0,0,0.8); color: white; border: none;
                            padding: 1rem 2rem; border-radius: 8px; font-size: 1.2rem;
                            cursor: pointer; z-index: 10;
                        `;
                        playButton.onclick = () => {
                            video.play();
                            playButton.remove();
                        };
                        video.parentElement.style.position = 'relative';
                        video.parentElement.appendChild(playButton);
                    });
                }
            }, 100);
        }
        
        function closeVideoModal() {
            const videoModal = document.getElementById('videoModal');
            if (videoModal) {
                videoModal.remove();
                document.body.style.overflow = 'auto';
            }
        }
        
        function viewDetailVideo() {
            if (currentRecipe && currentRecipe.receta_video) {
                openVideoModal(currentRecipe.receta_video);
            }
        }
        
        // ===== FUNCIONES MODAL DETALLE =====
        
        function closeRecipeDetail() {
            document.getElementById('recipeDetailModal').classList.add('hidden');
            document.body.style.overflow = 'auto'; // Restaurar scroll
        }
        
        function editCurrentRecipe() {
            if (!currentRecipe) return;
            
            // Cerrar modal de detalle
            closeRecipeDetail();
            
            // Rellenar modal de edición con datos actuales
            document.getElementById('editRecipeName').value = currentRecipe.receta_nombre;
            document.getElementById('editRecipeHealthy').checked = currentRecipe.receta_saludable;
            document.getElementById('editRecipeTime').value = currentRecipe.receta_tiempopreparacion || '';
            document.getElementById('editRecipePortions').value = currentRecipe.receta_porciones || '';
            document.getElementById('editRecipeRating').value = currentRecipe.receta_valoracion || 0;
            document.getElementById('editRecipeIngredients').value = currentRecipe.receta_ingredients || '';
            document.getElementById('editRecipePreparation').value = currentRecipe.receta_preparation || '';
            
            // Inicializar estrellas de valoración
            updateStars('#editRecipeModal', currentRecipe.receta_valoracion || 0);
            
            // Seleccionar tipo
            document.querySelectorAll('#editRecipeModal .type-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const typeButton = document.querySelector(`#editRecipeModal .type-button[data-type="${currentRecipe.receta_tipo}"]`);
            if (typeButton) {
                typeButton.classList.add('active');
                document.getElementById('editRecipeType').value = currentRecipe.receta_tipo;
            }
            
            // Inicializar componentes de imagen/video con datos actuales
            renderEditImageUploader(currentRecipe.receta_image || '');
            
            // Para video, extraer solo el nombre del archivo de la URL
            let videoFileName = '';
            if (currentRecipe.receta_video && currentRecipe.receta_video.trim() !== '') {
                const videoUrl = currentRecipe.receta_video;
                videoFileName = videoUrl.split('/').pop(); // Extraer nombre del archivo
            }
            renderEditVideoUploader(videoFileName);
            
            document.getElementById('editImageUrl').value = currentRecipe.receta_image || '';
            document.getElementById('editVideoUrl').value = currentRecipe.receta_video || '';
            
            // Abrir modal de edición
            document.getElementById('editRecipeModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function deleteCurrentRecipe() {
            if (!currentRecipe) return;
            
            if (confirm(`¿Estás seguro de que quieres eliminar "${currentRecipe.receta_nombre}"?`)) {
                fetch(API_BASE + 'delete.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        receta_id: currentRecipe.receta_id,
                        token: currentToken
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Receta eliminada exitosamente');
                        closeRecipeDetail();
                        loadRecipes(); // Recargar lista
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error de conexión: ' + error.message);
                });
            }
        }
        
        function saveEditRecipe() {
            if (!currentRecipe) return;
            
            const form = document.getElementById('editRecipeForm');
            const formData = new FormData();
            
            // Validar campos requeridos
            const nombre = document.getElementById('editRecipeName').value.trim();
            const tipo = document.getElementById('editRecipeType').value;
            
            if (!nombre) {
                alert('El nombre de la receta es obligatorio');
                return;
            }
            
            if (!tipo) {
                alert('Selecciona un tipo de receta');
                return;
            }
            
            // Recopilar datos
            formData.append('receta_id', currentRecipe.receta_id);
            formData.append('nombre', nombre);
            formData.append('tipo', tipo);
            formData.append('saludable', document.getElementById('editRecipeHealthy').checked ? 1 : 0);
            formData.append('tiempo', document.getElementById('editRecipeTime').value || 0);
            formData.append('porciones', document.getElementById('editRecipePortions').value || 1);
            formData.append('valoracion', document.getElementById('editRecipeRating').value || 0);
            formData.append('ingredientes', document.getElementById('editRecipeIngredients').value);
            formData.append('preparacion', document.getElementById('editRecipePreparation').value);
            formData.append('token', currentToken);
            
            // Archivos
            const imageFile = document.getElementById('editRecipeImage').files[0];
            const videoFile = document.getElementById('editRecipeVideo').files[0];
            
            if (imageFile) formData.append('imagen', imageFile);
            if (videoFile) formData.append('video', videoFile);
            
            // Si no hay archivos nuevos, mantener URLs existentes
            if (!imageFile) formData.append('imagen_url', document.getElementById('editImageUrl').value || '');
            if (!videoFile) formData.append('video_url', document.getElementById('editVideoUrl').value || '');
            
            // Enviar a API
            fetch(API_BASE + 'update.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Receta actualizada exitosamente');
                    closeEditRecipeModal();
                    loadRecipes(); // Recargar lista
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert('Error de conexión: ' + error.message);
            });
        }
        
        function closeEditRecipeModal() {
            document.getElementById('editRecipeModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ===== FUNCIONES DE VALORACIÓN CON ESTRELLAS =====
        
        function setNewRating(rating) {
            document.getElementById('newRecipeRating').value = rating;
            updateStars('#newRecipeModal', rating);
        }
        
        function setEditRating(rating) {
            document.getElementById('editRecipeRating').value = rating;
            updateStars('#editRecipeModal', rating);
        }
        
        function updateStars(modalSelector, rating) {
            const stars = document.querySelectorAll(modalSelector + ' .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        let saludableFilter = false;
        let searchTerm = '';

        function toggleSaludable() {
            saludableFilter = !saludableFilter;
            const btn = document.getElementById('saludableBtn');
            if (saludableFilter) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            applyFilters();
        }

        let searchVisible = false;
        
        function toggleSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            searchVisible = !searchVisible;
            
            if (searchVisible) {
                // Mostrar input de búsqueda DENTRO del panel
                searchInput.style.display = 'block';
                setTimeout(() => searchInput.focus(), 100);
                searchBtn.classList.add('active');
            } else {
                // Ocultar input de búsqueda
                searchInput.style.display = 'none';
                searchInput.value = '';
                searchTerm = '';
                searchBtn.classList.remove('active');
                applyFilters();
            }
        }
        
        function onSearchInput(event) {
            searchTerm = event.target.value.toLowerCase();
            applyFilters();
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            searchInput.value = '';
            searchTerm = '';
            searchVisible = false;
            
            // Ocultar input de búsqueda
            searchInput.style.display = 'none';
            searchBtn.classList.remove('active');
            
            applyFilters();
        }

        function applyFilters() {
            let filtered = allRecipes;
            
            // Filtro por tipo
            if (currentFilter) {
                filtered = filtered.filter(r => r.receta_tipo === currentFilter);
            }
            
            // Filtro saludable
            if (saludableFilter) {
                filtered = filtered.filter(r => r.receta_saludable);
            }
            
            // Filtro búsqueda
            if (searchTerm) {
                filtered = filtered.filter(function(r) {
                    return r.receta_nombre.toLowerCase().includes(searchTerm) ||
                           (r.receta_ingredients && r.receta_ingredients.toLowerCase().includes(searchTerm));
                });
            }
            
            displayRecipes(filtered);
            updateCounter(filtered.length, currentFilter !== '' || saludableFilter || searchTerm !== '');
        }



        function showRecipes() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('filtersPanel').classList.remove('hidden');
            document.getElementById('recipesContainer').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.nombre;
            
            // Cambiar a modo aplicación (quitar login-mode)
            document.getElementById('mainContent').classList.remove('login-mode');
            
            hideError(); // Ocultar cualquier error del login
            loadRecipes();
        }

        function showError(msg, isError = true) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = msg;
            errorElement.classList.remove('hidden');
            
            // Cambiar color según el tipo de mensaje
            if (isError) {
                errorElement.style.background = '#fee2e2';
                errorElement.style.color = '#dc2626';
            } else {
                errorElement.style.background = '#d1fae5';
                errorElement.style.color = '#065f46';
            }
            
            // Auto-ocultar todos los mensajes después de 5 segundos
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        function hideError() {
            const errorElement = document.getElementById('error');
            errorElement.classList.add('hidden');
        }

        function logout() {
            currentUser = null;
            currentToken = null;
            document.getElementById('header').classList.add('hidden');
            document.getElementById('filtersPanel').classList.add('hidden');
            document.getElementById('recipesContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            
            // Volver a modo login (con menos padding)
            document.getElementById('mainContent').classList.add('login-mode');
            
            showLoginForm(); // Volver al formulario de login
        }

        // ===== FUNCIONES DE AUTENTICACIÓN =====

        function showLoginForm() {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('verifyForm').classList.add('hidden');
            hideError(); // Ocultar errores al cambiar pestaña
        }

        function showRegisterForm() {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('verifyForm').classList.add('hidden');
            hideError(); // Ocultar errores al cambiar pestaña
        }

        function showVerifyForm(email) {
            document.getElementById('verifyEmailDisplay').textContent = email;
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('verifyForm').classList.remove('hidden');
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            // Validaciones
            if (password !== passwordConfirm) {
                showError('Las contraseñas no coinciden');
                return;
            }

            if (password.length < 6) {
                showError('La contraseña debe tener al menos 6 caracteres');
                return;
            }

            try {
                const response = await fetch(API_BASE + 'auth_register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'register',
                        name: name,
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showVerifyForm(email);
                    showError('📧 Código de verificación enviado a tu email', false);
                } else {
                    showError(data.error || 'Error en el registro');
                }
            } catch (error) {
                showError('Error de conexión: ' + error.message);
            }
        }

        async function handleVerification(e) {
            e.preventDefault();
            
            const email = document.getElementById('verifyEmailDisplay').textContent;
            const code = document.getElementById('verifyCode').value;

            try {
                const response = await fetch(API_BASE + 'auth_register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verify',
                        email: email,
                        code: code
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showError('✅ Email verificado correctamente. Ya puedes iniciar sesión.', false);
                    showLoginForm();
                    // Pre-llenar el email en el login
                    document.getElementById('loginEmail').value = email;
                } else {
                    showError(data.error || 'Código de verificación inválido');
                }
            } catch (error) {
                showError('Error de conexión: ' + error.message);
            }
        }

        async function resendVerificationCode() {
            const email = document.getElementById('verifyEmailDisplay').textContent;
            
            try {
                const response = await fetch(API_BASE + 'auth_register.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'resend_code',
                        email: email
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showError('📧 Nuevo código enviado a tu email', false);
                } else {
                    showError(data.error || 'Error al reenviar código');
                }
            } catch (error) {
                showError('Error de conexión: ' + error.message);
            }
        }

        function backToRegister() {
            showRegisterForm();
        }

        // ===== FUNCIONES PARA RECORDAR CREDENCIALES =====
        
        function loadSavedCredentials() {
            try {
                const savedEmail = localStorage.getItem('misrecetas_email');
                const savedPassword = localStorage.getItem('misrecetas_password');
                
                if (savedEmail) {
                    document.getElementById('loginEmail').value = savedEmail;
                }
                
                if (savedPassword) {
                    document.getElementById('loginPassword').value = savedPassword;
                }
                
                // Si hay credenciales guardadas, mostrar indicador
                if (savedEmail && savedPassword) {
                    const loginForm = document.getElementById('loginForm');
                    const indicator = document.createElement('p');
                    indicator.id = 'savedCredentialsIndicator';
                    indicator.style.cssText = 'font-size: 0.8rem; color: #22c55e; text-align: center; margin-top: 0.5rem;';
                    indicator.innerHTML = '✅ Credenciales guardadas';
                    loginForm.appendChild(indicator);
                }
            } catch (error) {
                console.log('Error cargando credenciales:', error);
            }
        }
        
        function saveCredentials(email, password) {
            try {
                localStorage.setItem('misrecetas_email', email);
                localStorage.setItem('misrecetas_password', password);
            } catch (error) {
                console.log('Error guardando credenciales:', error);
            }
        }
        
        function clearSavedCredentials() {
            try {
                localStorage.removeItem('misrecetas_email');
                localStorage.removeItem('misrecetas_password');
                
                // Limpiar campos del formulario
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
                // Eliminar indicador si existe
                const indicator = document.getElementById('savedCredentialsIndicator');
                if (indicator) {
                    indicator.remove();
                }
                
                // Mostrar confirmación
                showError('🗑️ Credenciales eliminadas', false);
                
            } catch (error) {
                console.log('Error eliminando credenciales:', error);
            }
        }
    </script>

    <!-- ===== MODAL DETALLE RECETA ===== -->
    <div id="recipeDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px; width: 90vw;">
            <!-- Header del modal -->
            <div class="modal-header">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: #dbeafe; display: flex; align-items: center; justify-content: center;">
                            <span style="color: #2563eb; font-size: 1.125rem;">🍳</span>
                        </div>
                        <div>
                            <h2 id="detailRecipeName" style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0;">Nombre de la receta</h2>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="editCurrentRecipe()" class="btn-modal-primary" title="Editar receta" style="background: #3b82f6;">
                            <span style="font-size: 0.875rem;">✏️</span>
                        </button>
                        <button onclick="deleteCurrentRecipe()" class="btn-modal-primary" title="Eliminar receta" style="background: #dc2626;">
                            <span style="font-size: 0.875rem;">🗑️</span>
                        </button>
                        <button onclick="closeRecipeDetail()" class="btn-modal-secondary" title="Cerrar">
                            <span style="font-size: 0.75rem;">✕</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contenido del modal -->
            <div class="modal-body">
                <!-- Imagen -->
                <div id="detailRecipeImage" style="margin-bottom: 1.5rem;"></div>
                
                <!-- Información básica -->
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; justify-content: center;">
                    <span id="detailRecipeType" style="background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; color: #374151;"></span>
                    <span id="detailRecipeRating" style="background: #fef3c7; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; color: #92400e;"></span>
                    <span id="detailRecipeTime" style="background: #e0e7ff; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; color: #3730a3;"></span>
                    <span id="detailRecipePortions" style="background: #ecfdf5; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; color: #065f46;"></span>
                    <span id="detailRecipeHealthy" style="background: #dcfce7; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; color: #166534; display: none;">💚 Saludable</span>
                    <span id="detailRecipeVideo" onclick="viewDetailVideo()" style="background: #dbeafe; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; color: #1e40af; display: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#bfdbfe'" onmouseout="this.style.background='#dbeafe'">📹 Video</span>
                </div>
                
                <!-- Separador -->
                <div style="border-top: 1px solid #e5e7eb; margin: 1.5rem 0;"></div>
                
                <!-- Ingredientes -->
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Ingredientes:</h3>
                    <p id="detailRecipeIngredients" style="color: #6b7280; line-height: 1.5; margin: 0; white-space: pre-wrap;"></p>
                </div>
                
                <!-- Preparación -->
                <div>
                    <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Preparación:</h3>
                    <p id="detailRecipePreparation" style="color: #6b7280; line-height: 1.5; margin: 0; white-space: pre-wrap;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL NUEVA RECETA ===== -->
    <div id="newRecipeModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px; width: 90vw;">
            <!-- Header del modal -->
            <div class="modal-header">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: #dcfce7; display: flex; align-items: center; justify-content: center;">
                            <span style="color: #16a34a; font-size: 1.125rem;">✨</span>
                        </div>
                        <div>
                            <h2 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0;">Nueva Receta</h2>
                            <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Crea una nueva receta deliciosa</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="saveNewRecipe()" class="btn-modal-primary" title="Guardar receta">
                            <span style="font-size: 0.875rem;">💾</span>
                        </button>
                        <button onclick="closeNewRecipeModal()" class="btn-modal-secondary" title="Cerrar">
                            <span style="font-size: 0.75rem;">✕</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contenido del modal -->
            <div class="modal-body">
                <form id="newRecipeForm" class="modal-form">
                    <!-- Nombre de la receta y Saludable -->
                    <div style="display: flex; align-items: end; justify-content: space-between; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1;">
                            <label>Nombre de la receta *</label>
                            <input type="text" id="newRecipeName" required placeholder="Ej: Paella de Marisco">
                        </div>
                        
                        <!-- Toggle Saludable -->
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <label style="margin-bottom: 0.5rem;">Saludable</label>
                            <label class="health-toggle-container">
                                <input type="checkbox" id="newRecipeHealthy" class="health-toggle-input">
                                <div class="health-toggle-slider">
                                    <div class="health-toggle-knob"></div>
                                </div>
                                <span style="font-size: 1.125rem;">💚</span>
                            </label>
                        </div>
                    </div>

                    <!-- Imagen -->
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.5rem; margin-right: 0.5rem;">🖼️</span>
                            <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Imagen</span>
                        </div>
                        <input type="file" id="newRecipeImage" accept="image/*" style="display: none;" onchange="handleNewImageUpload(this)">
                        <input type="hidden" id="newImageUrl">
                        <div id="newImageContainer">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Separador -->
                    <div style="border-top: 1px solid #e5e7eb; margin: 1.5rem 0;"></div>

                    <!-- Tipos de receta -->
                    <div style="margin-bottom: 1.5rem;">
                        <label>Tipo de receta *</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                            <button type="button" onclick="selectNewType('Entrante')" class="type-button" data-type="Entrante">
                                <span>🫒</span>
                                <span>Entrante</span>
                            </button>
                            <button type="button" onclick="selectNewType('Principal')" class="type-button" data-type="Principal">
                                <span>🥘</span>
                                <span>Principal</span>
                            </button>
                            <button type="button" onclick="selectNewType('Postre')" class="type-button" data-type="Postre">
                                <span>🍰</span>
                                <span>Postre</span>
                            </button>
                            <button type="button" onclick="selectNewType('Bebida')" class="type-button" data-type="Bebida">
                                <span>🥤</span>
                                <span>Bebida</span>
                            </button>
                            <button type="button" onclick="selectNewType('Extra')" class="type-button" data-type="Extra">
                                <span>🧺</span>
                                <span>Extra</span>
                            </button>
                        </div>
                        <input type="hidden" id="newRecipeType" required>
                    </div>

                    <!-- Separador -->
                    <div style="border-top: 1px solid #e5e7eb; margin: 1.5rem 0;"></div>

                    <!-- Tiempo, Porciones y Valoración -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1;">
                            <label>Tiempo (min)</label>
                            <input type="number" id="newRecipeTime" min="1" max="600" placeholder="30">
                        </div>
                        <div style="flex: 1;">
                            <label>Porc</label>
                            <input type="number" id="newRecipePortions" min="1" max="20" placeholder="4">
                        </div>
                        <div style="flex: 1;">
                            <label>⭐ Valoración</label>
                            <div style="display: flex; gap: 2px; margin-top: 0.5rem;">
                                <span class="star" data-rating="1" onclick="setNewRating(1)">⭐</span>
                                <span class="star" data-rating="2" onclick="setNewRating(2)">⭐</span>
                                <span class="star" data-rating="3" onclick="setNewRating(3)">⭐</span>
                                <span class="star" data-rating="4" onclick="setNewRating(4)">⭐</span>
                                <span class="star" data-rating="5" onclick="setNewRating(5)">⭐</span>
                            </div>
                            <input type="hidden" id="newRecipeRating" value="0">
                        </div>
                    </div>

                    <!-- Ingredientes -->
                    <div class="form-group">
                        <label>Ingredientes</label>
                        <textarea id="newRecipeIngredients" rows="4" placeholder="Lista de ingredientes..."></textarea>
                    </div>

                    <!-- Preparación -->
                    <div class="form-group">
                        <label>Preparación</label>
                        <textarea id="newRecipePreparation" rows="6" placeholder="Pasos de preparación..."></textarea>
                    </div>

                    <!-- Video -->
                    <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 12px; margin-bottom: 1.5rem; margin-top: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem; margin-right: 0.5rem;">🎥</span>
                            <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Video</span>
                        </div>
                        <input type="file" id="newRecipeVideo" accept="video/*" style="display: none;" onchange="handleNewVideoUpload(this)">
                        <input type="hidden" id="newVideoUrl">
                        <div id="newVideoContainer">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===== MODAL EDITAR RECETA ===== -->
    <div id="editRecipeModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px; width: 90vw;">
            <!-- Header del modal -->
            <div class="modal-header">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: #dbeafe; display: flex; align-items: center; justify-content: center;">
                            <span style="color: #2563eb; font-size: 1.125rem;">✏️</span>
                        </div>
                        <div>
                            <h2 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0;">Editar Receta</h2>
                            <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Modifica tu receta</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="saveEditRecipe()" class="btn-modal-primary" title="Guardar cambios">
                            <span style="font-size: 0.875rem;">💾</span>
                        </button>
                        <button onclick="closeEditRecipeModal()" class="btn-modal-secondary" title="Cerrar">
                            <span style="font-size: 0.75rem;">✕</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contenido del modal -->
            <div class="modal-body">
                <form id="editRecipeForm" class="modal-form">
                    <!-- Nombre de la receta y Saludable -->
                    <div style="display: flex; align-items: end; justify-content: space-between; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1;">
                            <label>Nombre de la receta *</label>
                            <input type="text" id="editRecipeName" required>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <label style="margin-bottom: 0.5rem;">Saludable</label>
                            <label class="health-toggle-container">
                                <input type="checkbox" id="editRecipeHealthy" class="health-toggle-input">
                                <div class="health-toggle-slider">
                                    <div class="health-toggle-knob"></div>
                                </div>
                                <span style="font-size: 1.125rem;">💚</span>
                            </label>
                        </div>
                    </div>

                    <!-- Imagen -->
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.5rem; margin-right: 0.5rem;">🖼️</span>
                            <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Imagen</span>
                        </div>
                        <input type="file" id="editRecipeImage" accept="image/*" style="display: none;" onchange="handleEditImageUpload(this)">
                        <input type="hidden" id="editImageUrl">
                        <div id="editImageContainer">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Video -->
                    <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 12px; margin-bottom: 1.5rem; margin-top: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem; margin-right: 0.5rem;">🎥</span>
                            <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Video</span>
                        </div>
                        <input type="file" id="editRecipeVideo" accept="video/*" style="display: none;" onchange="handleEditVideoUpload(this)">
                        <input type="hidden" id="editVideoUrl">
                        <div id="editVideoContainer">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <div style="border-top: 1px solid #e5e7eb; margin: 1.5rem 0;"></div>

                    <!-- Tipos -->
                    <div style="margin-bottom: 1.5rem;">
                        <label>Tipo de receta *</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                            <button type="button" onclick="selectEditType('Entrante')" class="type-button" data-type="Entrante">
                                <span>🫒</span>
                                <span>Entrante</span>
                            </button>
                            <button type="button" onclick="selectEditType('Principal')" class="type-button" data-type="Principal">
                                <span>🥘</span>
                                <span>Principal</span>
                            </button>
                            <button type="button" onclick="selectEditType('Postre')" class="type-button" data-type="Postre">
                                <span>🍰</span>
                                <span>Postre</span>
                            </button>
                            <button type="button" onclick="selectEditType('Bebida')" class="type-button" data-type="Bebida">
                                <span>🥤</span>
                                <span>Bebida</span>
                            </button>
                            <button type="button" onclick="selectEditType('Extra')" class="type-button" data-type="Extra">
                                <span>🧺</span>
                                <span>Extra</span>
                            </button>
                        </div>
                        <input type="hidden" id="editRecipeType" required>
                    </div>

                    <div style="border-top: 1px solid #e5e7eb; margin: 1.5rem 0;"></div>

                    <!-- Tiempo, Porciones y Valoración -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1;">
                            <label>Tiempo (min)</label>
                            <input type="number" id="editRecipeTime" min="1" max="600">
                        </div>
                        <div style="flex: 1;">
                            <label>Porc</label>
                            <input type="number" id="editRecipePortions" min="1" max="20">
                        </div>
                        <div style="flex: 1;">
                            <label>⭐ Valoración</label>
                            <div style="display: flex; gap: 2px; margin-top: 0.5rem;">
                                <span class="star" data-rating="1" onclick="setEditRating(1)">⭐</span>
                                <span class="star" data-rating="2" onclick="setEditRating(2)">⭐</span>
                                <span class="star" data-rating="3" onclick="setEditRating(3)">⭐</span>
                                <span class="star" data-rating="4" onclick="setEditRating(4)">⭐</span>
                                <span class="star" data-rating="5" onclick="setEditRating(5)">⭐</span>
                            </div>
                            <input type="hidden" id="editRecipeRating" value="0">
                        </div>
                    </div>

                    <!-- Ingredientes -->
                    <div class="form-group">
                        <label>Ingredientes</label>
                        <textarea id="editRecipeIngredients" rows="4"></textarea>
                    </div>

                    <!-- Preparación -->
                    <div class="form-group">
                        <label>Preparación</label>
                        <textarea id="editRecipePreparation" rows="6"></textarea>
                    </div>

                </form>
            </div>
        </div>
    </div>

</body>
</html>
